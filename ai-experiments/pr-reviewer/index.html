<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Advanced PR Reviewer</title>
  <!-- Import Vue 3 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.3.4/vue.global.prod.min.js"></script>
  <!-- Import Octokit for GitHub API -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/octokit/2.0.14/octokit.min.js"></script>
  <!-- Import diff2html for rendering diffs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/diff2html/3.4.35/diff2html.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/diff2html/3.4.35/diff2html.min.css">
  <!-- Import Tailwind CSS for styling -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.js"></script>
  <!-- Import Prism for syntax highlighting -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css">
  <!-- Import Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    [v-cloak] { display: none; }
    
    .theme-light {
      --color-bg-primary: #ffffff;
      --color-bg-secondary: #f8f9fa;
      --color-text-primary: #333333;
      --color-text-secondary: #6c757d;
      --color-border: #e9ecef;
      --color-highlight: #007bff;
      --color-added: #e6ffed;
      --color-removed: #ffebe9;
      --color-modified: #f8f8f8;
      --color-renamed: #f1f8ff;
    }
    
    .theme-dark {
      --color-bg-primary: #21252b;
      --color-bg-secondary: #282c34;
      --color-text-primary: #abb2bf;
      --color-text-secondary: #828997;
      --color-border: #3e4451;
      --color-highlight: #61afef;
      --color-added: #2c4c3b;
      --color-removed: #4c2c2c;
      --color-modified: #2c354c;
      --color-renamed: #2c3c4c;
    }
    
    body {
      background-color: var(--color-bg-primary);
      color: var(--color-text-primary);
    }
    
    .file-list {
      max-height: calc(100vh - 300px);
      overflow-y: auto;
    }
    
    .file-item {
      border-bottom: 1px solid var(--color-border);
      padding: 8px;
      display: flex;
      align-items: center;
      cursor: pointer;
    }
    
    .file-item:hover {
      background-color: var(--color-bg-secondary);
    }
    
    .file-item.selected {
      background-color: var(--color-bg-secondary);
      border-left: 3px solid var(--color-highlight);
    }
    
    .file-item.added {
      border-left: 3px solid #28a745;
    }
    
    .file-item.modified {
      border-left: 3px solid #ffc107;
    }
    
    .file-item.removed {
      border-left: 3px solid #dc3545;
    }
    
    .file-item.renamed {
      border-left: 3px solid #17a2b8;
    }
    
    .diff-container {
      padding: 16px;
      border-radius: 4px;
      border: 1px solid var(--color-border);
      background-color: var(--color-bg-secondary);
    }
    
    /* Mobile responsiveness */
    @media (max-width: 768px) {
      .main-container {
        flex-direction: column;
      }
      
      .file-list {
        max-height: 200px;
      }
    }
    
    /* Custom styling for search component */
    .search-highlight {
      background-color: #ff8;
      font-weight: bold;
    }
    
    /* Loading spinner */
    .loader {
      border: 4px solid var(--color-border);
      border-top: 4px solid var(--color-highlight);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* Custom styling for diff views */
    .d2h-wrapper {
      width: 100%;
    }
    
    /* Animation for dynamic filters */
    .filter-enter-active, .filter-leave-active {
      transition: opacity 0.3s;
    }
    .filter-enter-from, .filter-leave-to {
      opacity: 0;
    }
  </style>
</head>
<body>
  <div id="app" v-cloak :class="theme">
    <template>
      <!-- App header with repository configuration -->
      <div class="p-4 border-b border-gray-200 flex flex-col md:flex-row items-start md:items-center justify-between">
        <h1 class="text-2xl font-bold mb-4 md:mb-0">Advanced PR Reviewer</h1>
        
        <div class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
          <!-- Theme toggle -->
          <button 
            @click="toggleTheme" 
            class="p-2 rounded hover:bg-gray-200 dark:hover:bg-gray-700 focus:outline-none"
            :title="theme === 'theme-light' ? 'Switch to dark mode' : 'Switch to light mode'"
          >
            <i :class="theme === 'theme-light' ? 'fas fa-moon' : 'fas fa-sun'"></i>
          </button>
          
          <!-- Repository source tabs -->
          <div class="flex border rounded overflow-hidden">
            <button 
              @click="repoSource = 'github'" 
              :class="['px-3 py-1', repoSource === 'github' ? 'bg-blue-500 text-white' : 'bg-gray-200']"
            >
              GitHub
            </button>
            <button 
              @click="repoSource = 'local'" 
              :class="['px-3 py-1', repoSource === 'local' ? 'bg-blue-500 text-white' : 'bg-gray-200']"
            >
              Local
            </button>
          </div>
        </div>
      </div>
      
      <!-- Repository configuration -->
      <div class="p-4 border-b border-gray-200">
        <div v-if="repoSource === 'github'">
          <div class="flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0">
            <div class="flex-1">
              <label class="block text-sm font-medium mb-1">GitHub Repository URL</label>
              <input 
                v-model="githubRepoUrl" 
                @keyup.enter="fetchRepositoryData"
                class="w-full px-3 py-2 border rounded" 
                placeholder="https://github.com/owner/repo"
              >
            </div>
            <div class="md:w-1/4">
              <label class="block text-sm font-medium mb-1">Base Branch</label>
              <input 
                v-model="baseBranch" 
                class="w-full px-3 py-2 border rounded" 
                placeholder="main"
              >
            </div>
            <div class="md:w-1/4">
              <label class="block text-sm font-medium mb-1">Compare Branch</label>
              <input 
                v-model="compareBranch" 
                class="w-full px-3 py-2 border rounded" 
                placeholder="feature-branch"
              >
            </div>
            <div class="flex items-end">
              <button 
                @click="fetchRepositoryData" 
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                :disabled="loading"
              >
                <i class="fas fa-sync-alt mr-2"></i> Load
              </button>
            </div>
          </div>
          
          <div v-if="hasGithubToken" class="mt-2 text-sm text-green-600">
            <i class="fas fa-check-circle mr-1"></i> GitHub token configured
          </div>
          <div v-else class="mt-2">
            <label class="block text-sm font-medium mb-1">GitHub Access Token (optional)</label>
            <div class="flex">
              <input 
                v-model="githubToken" 
                type="password" 
                class="flex-1 px-3 py-2 border rounded-l" 
                placeholder="For private repositories"
              >
              <button 
                @click="saveGithubToken" 
                class="px-3 py-2 bg-gray-200 rounded-r hover:bg-gray-300"
              >
                Save
              </button>
            </div>
          </div>
        </div>
        
        <div v-else>
          <div class="flex flex-col md:flex-row md:space-x-4 space-y-2 md:space-y-0">
            <div class="flex-1">
              <label class="block text-sm font-medium mb-1">Local Repository Path</label>
              <input 
                v-model="localRepoPath" 
                class="w-full px-3 py-2 border rounded" 
                placeholder="/path/to/your/repository"
              >
            </div>
            <div class="md:w-1/4">
              <label class="block text-sm font-medium mb-1">Base Branch</label>
              <input 
                v-model="baseBranch" 
                class="w-full px-3 py-2 border rounded" 
                placeholder="main"
              >
            </div>
            <div class="md:w-1/4">
              <label class="block text-sm font-medium mb-1">Compare Branch</label>
              <input 
                v-model="compareBranch" 
                class="w-full px-3 py-2 border rounded" 
                placeholder="feature-branch"
              >
            </div>
            <div class="flex items-end">
              <button 
                @click="loadLocalRepository" 
                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
                :disabled="loading"
              >
                <i class="fas fa-folder-open mr-2"></i> Load
              </button>
            </div>
          </div>
          <div class="mt-2 text-sm text-gray-600">
            <i class="fas fa-info-circle mr-1"></i> For local repositories, ensure your application has permission to access the filesystem
          </div>
        </div>
      </div>
      
      <div v-if="loading" class="flex justify-center items-center p-8">
        <div class="loader"></div>
        <p class="ml-4">Loading repository data...</p>
      </div>
      
      <div v-else-if="error" class="p-4 bg-red-100 border border-red-400 text-red-700 rounded">
        <p class="font-bold">Error:</p>
        <p>{{ error }}</p>
      </div>
      
      <!-- Main content area with file list and diff viewer -->
      <div v-else-if="fileChanges.length > 0" class="flex flex-col md:flex-row main-container">
        <!-- Left sidebar with file list and filters -->
        <div class="md:w-1/3 lg:w-1/4 border-r border-gray-200 p-4">
          <!-- File search and filters -->
          <div class="mb-4">
            <div class="relative">
              <input 
                v-model="fileSearchQuery" 
                class="w-full px-3 py-2 pl-10 border rounded" 
                placeholder="Search files..."
              >
              <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
            </div>
            
            <div class="flex flex-wrap gap-2 mt-3">
              <button 
                @click="toggleFilterPanel" 
                class="px-3 py-1 bg-gray-200 rounded-full text-sm hover:bg-gray-300 flex items-center"
              >
                <i class="fas fa-filter mr-1"></i> Filters 
                <i :class="['ml-1 fas', showFilterPanel ? 'fa-chevron-up' : 'fa-chevron-down']"></i>
              </button>
              
              <div 
                v-for="(filter, index) in activeFilters" 
                :key="index"
                class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm flex items-center"
              >
                {{ filter.label }}
                <button @click="removeFilter(index)" class="ml-1 text-blue-500 hover:text-blue-700">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
            
            <!-- Expandable filter panel -->
            <div v-if="showFilterPanel" class="mt-3 p-3 border rounded bg-gray-50">
              <div class="mb-3">
                <label class="block text-sm font-medium mb-1">File Status</label>
                <div class="flex flex-wrap gap-2">
                  <button 
                    v-for="status in ['added', 'modified', 'removed', 'renamed']"
                    :key="status"
                    @click="addFilter('status', status)"
                    class="px-2 py-1 border rounded-full text-xs capitalize hover:bg-gray-200"
                    :class="{'bg-blue-100 border-blue-300': isFilterActive('status', status)}"
                  >
                    {{ status }}
                  </button>
                </div>
              </div>
              
              <div class="mb-3">
                <label class="block text-sm font-medium mb-1">File Extensions</label>
                <div class="flex flex-wrap gap-2">
                  <button 
                    v-for="ext in availableExtensions"
                    :key="ext"
                    @click="addFilter('extension', ext)"
                    class="px-2 py-1 border rounded-full text-xs hover:bg-gray-200"
                    :class="{'bg-blue-100 border-blue-300': isFilterActive('extension', ext)}"
                  >
                    {{ ext || 'no extension' }}
                  </button>
                </div>
              </div>
              
              <div>
                <label class="block text-sm font-medium mb-1">Advanced Search</label>
                <div class="flex items-center">
                  <input 
                    v-model="regexSearch" 
                    class="flex-1 px-3 py-2 border rounded-l" 
                    placeholder="Regular expression..."
                  >
                  <button 
                    @click="applyRegexSearch" 
                    class="px-3 py-2 bg-gray-200 rounded-r hover:bg-gray-300"
                  >
                    Apply
                  </button>
                </div>
                <div class="flex items-center mt-2">
                  <label class="inline-flex items-center">
                    <input type="checkbox" v-model="caseSensitiveSearch" class="form-checkbox">
                    <span class="ml-2 text-sm">Case sensitive</span>
                  </label>
                </div>
              </div>
            </div>
          </div>
          
          <!-- File list with counts -->
          <div class="flex justify-between items-center mb-2">
            <h2 class="text-lg font-semibold">Changed Files</h2>
            <span class="text-sm bg-gray-200 px-2 py-1 rounded">{{ filteredFiles.length }} of {{ fileChanges.length }}</span>
          </div>
          
          <div class="file-list">
            <div 
              v-for="file in filteredFiles" 
              :key="file.filename"
              @click="selectFile(file)"
              class="file-item"
              :class="[file.status, selectedFile && selectedFile.filename === file.filename ? 'selected' : '']"
            >
              <span 
                class="w-6 text-center mr-2" 
                :title="file.status"
              >
                <i 
                  :class="[
                    'fas', 
                    file.status === 'added' ? 'fa-plus text-green-600' : 
                    file.status === 'removed' ? 'fa-minus text-red-600' : 
                    file.status === 'modified' ? 'fa-pen text-yellow-600' : 
                    'fa-arrow-right-arrow-left text-blue-600'
                  ]"
                ></i>
              </span>
              <span class="truncate flex-1">
                {{ file.filename }}
              </span>
              <span class="text-xs ml-2 text-gray-500">
                {{ getChangeSummary(file) }}
              </span>
            </div>
          </div>
        </div>
        
        <!-- Right side with file diff viewer -->
        <div class="flex-1 p-4">
          <div v-if="!selectedFile" class="flex flex-col items-center justify-center h-full text-gray-500">
            <i class="fas fa-code-branch text-6xl mb-4"></i>
            <p class="text-xl">Select a file to view changes</p>
          </div>
          
          <div v-else>
            <!-- File info and view options -->
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 pb-2 border-b">
              <div>
                <h2 class="text-xl font-semibold truncate">{{ selectedFile.filename }}</h2>
                <div class="text-sm text-gray-600">
                  <span 
                    :class="[
                      'px-2 py-0.5 rounded-full text-white text-xs mr-2',
                      selectedFile.status === 'added' ? 'bg-green-600' : 
                      selectedFile.status === 'removed' ? 'bg-red-600' : 
                      selectedFile.status === 'modified' ? 'bg-yellow-600' : 
                      'bg-blue-600'
                    ]"
                  >
                    {{ selectedFile.status }}
                  </span>
                  <span>{{ getChangeSummary(selectedFile) }}</span>
                </div>
              </div>
              
              <!-- View options -->
              <div class="flex mt-2 sm:mt-0">
                <div class="flex border rounded overflow-hidden">
                  <button 
                    @click="viewMode = 'split'"
                    :class="['px-3 py-1 flex items-center', viewMode === 'split' ? 'bg-blue-500 text-white' : 'bg-gray-200']"
                  >
                    <i class="fas fa-columns mr-1"></i> Split
                  </button>
                  <button 
                    @click="viewMode = 'unified'"
                    :class="['px-3 py-1 flex items-center', viewMode === 'unified' ? 'bg-blue-500 text-white' : 'bg-gray-200']"
                  >
                    <i class="fas fa-align-left mr-1"></i> Unified
                  </button>
                </div>
                
                <button 
                  @click="toggleInlineComments"
                  :class="['ml-2 px-3 py-1 border rounded flex items-center', showInlineComments ? 'bg-blue-100' : 'bg-gray-200']"
                  title="Toggle inline comments"
                >
                  <i class="fas fa-comment-dots"></i>
                </button>
              </div>
            </div>
            
            <!-- File content search -->
            <div v-if="isDiffAvailable" class="mb-4">
              <div class="relative">
                <input 
                  v-model="contentSearchQuery" 
                  @keyup.enter="searchInContent"
                  class="w-full px-3 py-2 pl-10 border rounded" 
                  placeholder="Search in file content..."
                >
                <i class="fas fa-search absolute left-3 top-3 text-gray-400"></i>
                <div class="absolute right-2 top-2">
                  <button 
                    @click="searchInContent"
                    class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300 text-sm"
                  >
                    Find
                  </button>
                </div>
              </div>
              <div v-if="contentSearchMatches.length > 0" class="mt-2 text-sm">
                <span>{{ currentMatchIndex + 1 }} of {{ contentSearchMatches.length }} matches</span>
                <button 
                  @click="navigateToPrevMatch"
                  class="ml-2 px-2 py-0.5 bg-gray-200 rounded hover:bg-gray-300"
                  :disabled="currentMatchIndex === 0"
                >
                  <i class="fas fa-chevron-up"></i>
                </button>
                <button 
                  @click="navigateToNextMatch"
                  class="ml-1 px-2 py-0.5 bg-gray-200 rounded hover:bg-gray-300"
                  :disabled="currentMatchIndex === contentSearchMatches.length - 1"
                >
                  <i class="fas fa-chevron-down"></i>
                </button>
              </div>
            </div>
            
            <!-- Binary file info -->
            <div v-if="isBinaryFile" class="p-8 text-center bg-gray-100 rounded">
              <i class="fas fa-file-binary text-4xl mb-3 text-gray-500"></i>
              <p class="text-lg">Binary file not shown</p>
              <p class="text-sm text-gray-600 mt-2">This file appears to be a binary file and cannot be displayed in the diff viewer.</p>
            </div>
            
            <!-- Large file warning -->
            <div v-else-if="isLargeFile" class="p-8 text-center bg-gray-100 rounded">
              <i class="fas fa-file-alt text-4xl mb-3 text-gray-500"></i>
              <p class="text-lg">Large file</p>
              <p class="text-sm text-gray-600 mt-2">This file is too large to display in the diff viewer.</p>
              <button 
                @click="loadLargeFile" 
                class="mt-4 px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600"
              >
                Load anyway
              </button>
            </div>
            
            <!-- File diff viewer -->
            <div v-else-if="isDiffAvailable" class="diff-container" ref="diffContainer"></div>
            
            <!-- No content available -->
            <div v-else class="p-8 text-center bg-gray-100 rounded">
              <i class="fas fa-exclamation-circle text-4xl mb-3 text-gray-500"></i>
              <p class="text-lg">No diff content available</p>
              <p class="text-sm text-gray-600 mt-2">Unable to load the diff for this file.</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Initial state - no repository loaded -->
      <div v-else class="flex flex-col items-center justify-center p-16 text-center">
        <i class="fas fa-code-branch text-6xl mb-6 text-gray-400"></i>
        <h2 class="text-2xl font-bold mb-2">No Repository Loaded</h2>
        <p class="text-gray-600 max-w-lg mb-6">
          Enter your repository details above and click load to start reviewing changes between branches.
        </p>
        <div class="text-left bg-gray-100 p-4 rounded max-w-lg">
          <h3 class="font-bold mb-2">Features:</h3>
          <ul class="space-y-1 text-sm text-gray-700">
            <li><i class="fas fa-check text-green-600 mr-2"></i> Advanced file filtering by extension and change type</li>
            <li><i class="fas fa-check text-green-600 mr-2"></i> Split and unified diff views</li>
            <li><i class="fas fa-check text-green-600 mr-2"></i> Regular expression search in files</li>
            <li><i class="fas fa-check text-green-600 mr-2"></i> Support for GitHub and local repositories</li>
            <li><i class="fas fa-check text-green-600 mr-2"></i> Light and dark themes</li>
            <li><i class="fas fa-check text-green-600 mr-2"></i> Responsive design for all devices</li>
          </ul>
        </div>
      </div>
    </template>
  </div>

  <script>
    const { createApp, ref, computed, watch, onMounted, nextTick } = Vue;
    
    const app = createApp({
      setup() {
        // App state
        const theme = ref('theme-light');
        const repoSource = ref('github');
        const loading = ref(false);
        const error = ref(null);
        
        // Repository configuration
        const githubRepoUrl = ref('');
        const githubToken = ref('');
        const hasGithubToken = ref(false);
        const localRepoPath = ref('');
        const baseBranch = ref('main');
        const compareBranch = ref('');
        
        // File list and selection
        const fileChanges = ref([]);
        const selectedFile = ref(null);
        const viewMode = ref('split');
        const showInlineComments = ref(false);
        
        // Filtering and search
        const fileSearchQuery = ref('');
        const contentSearchQuery = ref('');
        const showFilterPanel = ref(false);
        const activeFilters = ref([]);
        const regexSearch = ref('');
        const caseSensitiveSearch = ref(false);
        const contentSearchMatches = ref([]);
        const currentMatchIndex = ref(0);
        
        // File content flags
        const isBinaryFile = ref(false);
        const isLargeFile = ref(false);
        
        // DOM refs
        const diffContainer = ref(null);
        
        // Computed properties
        const availableExtensions = computed(() => {
          const extensions = new Set();
          fileChanges.value.forEach(file => {
            const ext = file.filename.split('.').pop();
            if (ext !== file.filename) {
              extensions.add(ext);
            } else {
              extensions.add('');
            }
          });
          return Array.from(extensions).sort();
        });
        
        const filteredFiles = computed(() => {
          if (activeFilters.value.length === 0 && !fileSearchQuery.value) {
            return fileChanges.value;
          }
          
          return fileChanges.value.filter(file => {
            // Text search
            if (fileSearchQuery.value && 
                !file.filename.toLowerCase().includes(fileSearchQuery.value.toLowerCase())) {
              return false;
            }
            
            // Apply active filters
            for (const filter of activeFilters.value) {
              if (filter.type === 'status' && file.status !== filter.value) {
                return false;
              }
              
              if (filter.type === 'extension') {
                const fileExt = file.filename.split('.').pop();
                const hasExtension = fileExt !== file.filename;
                
                if (filter.value === '' && hasExtension) {
                  return false;
                } else if (filter.value !== '' && (!hasExtension || fileExt !== filter.value)) {
                  return false;
                }
              }
              
              if (filter.type === 'regex') {
                try {
                  const flags = caseSensitiveSearch.value ? '' : 'i';
                  const regex = new RegExp(filter.value, flags);
                  if (!regex.test(file.filename)) {
                    return false;
                  }
                } catch (e) {
                  // Invalid regex, skip this filter
                  console.error('Invalid regex:', e);
                }
              }
            }
            
            return true;
          });
        });
        
        const isDiffAvailable = computed(() => {
          return selectedFile.value && 
                 !isBinaryFile.value && 
                 !isLargeFile.value;
        });
        
        // Methods
        function toggleTheme() {
          theme.value = theme.value === 'theme-light' ? 'theme-dark' : 'theme-light';
          document.body.className = theme.value;
          
          // Re-render diff if necessary
          if (selectedFile.value) {
            nextTick(() => {
              renderDiff(selectedFile.value);
            });
          }
        }
        
        function toggleFilterPanel() {
          showFilterPanel.value = !showFilterPanel.value;
        }
        
        function saveGithubToken() {
          if (githubToken.value) {
            localStorage.setItem('github_token', githubToken.value);
            hasGithubToken.value = true;
            githubToken.value = '';
          }
        }
        
        function addFilter(type, value) {
          // Don't add duplicate filters
          if (isFilterActive(type, value)) {
            // Remove the filter instead
            removeFilterByTypeAndValue(type, value);
            return;
          }
          
          let label = '';
          if (type === 'status') {
            label = `Status: ${value}`;
          } else if (type === 'extension') {
            label = `Extension: ${value || 'none'}`;
          } else if (type === 'regex') {
            label = `Regex: ${value}`;
          }
          
          activeFilters.value.push({ type, value, label });
        }
        
        function removeFilter(index) {
          activeFilters.value.splice(index, 1);
        }
        
        function removeFilterByTypeAndValue(type, value) {
          const index = activeFilters.value.findIndex(f => f.type === type && f.value === value);
          if (index !== -1) {
            removeFilter(index);
          }
        }
        
        function isFilterActive(type, value) {
          return activeFilters.value.some(f => f.type === type && f.value === value);
        }
        
        function applyRegexSearch() {
          if (regexSearch.value) {
            try {
              // Test if regex is valid
              new RegExp(regexSearch.value);
              
              // Add as filter
              addFilter('regex', regexSearch.value);
              regexSearch.value = '';
            } catch (e) {
              error.value = `Invalid regular expression: ${e.message}`;
              setTimeout(() => {
                error.value = null;
              }, 3000);
            }
          }
        }
        
        async function fetchRepositoryData() {
          if (!githubRepoUrl.value) {
            error.value = 'Please enter a GitHub repository URL';
            return;
          }
          
          if (!compareBranch.value) {
            error.value = 'Please enter a compare branch name';
            return;
          }
          
          loading.value = true;
          error.value = null;
          fileChanges.value = [];
          selectedFile.value = null;
          
          try {
            // Parse GitHub URL
            const urlMatch = githubRepoUrl.value.match(/github\.com\/([^/]+)\/([^/]+)/);
            if (!urlMatch) {
              throw new Error('Invalid GitHub repository URL');
            }
            
            const owner = urlMatch[1];
            const repo = urlMatch[2].replace('.git', '');
            
            // Get saved token if available
            const token = localStorage.getItem('github_token');
            
            // Initialize Octokit
            const octokit = new Octokit.Octokit({
              auth: token || undefined
            });
            
            // Fetch comparison between branches
            const response = await octokit.rest.repos.compareCommits({
              owner,
              repo,
              base: baseBranch.value,
              head: compareBranch.value
            });
            
            if (response.status !== 200) {
              throw new Error('Failed to fetch comparison data');
            }
            
            // Process files
            fileChanges.value = response.data.files.map(file => ({
              filename: file.filename,
              status: file.status,
              additions: file.additions,
              deletions: file.deletions,
              changes: file.changes,
              patch: file.patch,
              raw_url: file.raw_url,
              contents_url: file.contents_url,
              binary: file.binary || false
            }));
            
            // Sort files by path
            fileChanges.value.sort((a, b) => a.filename.localeCompare(b.filename));
            
            // Select first file automatically if available
            if (fileChanges.value.length > 0) {
              selectFile(fileChanges.value[0]);
            }
          } catch (err) {
            console.error('Error fetching repository data:', err);
            error.value = `Error: ${err.message || 'Failed to fetch repository data'}`;
          } finally {
            loading.value = false;
          }
        }
        
        async function loadLocalRepository() {
          // This is a placeholder for local repository loading functionality
          // In a real implementation, this would use a backend service or local filesystem access
          
          error.value = 'Local repository functionality requires a backend service. For this demo, please use GitHub repositories.';
          
          // In a real implementation:
          // 1. Send request to backend service with repository path and branch info
          // 2. Backend executes git commands to get diff
          // 3. Process and display results similar to GitHub implementation
        }
        
        function selectFile(file) {
          selectedFile.value = file;
          isBinaryFile.value = file.binary === true;
          isLargeFile.value = !isBinaryFile.value && getFileSize(file) > 100000; // 100KB limit
          contentSearchMatches.value = [];
          currentMatchIndex.value = 0;
          
          if (!isBinaryFile.value && !isLargeFile.value) {
            nextTick(() => {
              renderDiff(file);
            });
          }
        }
        
        function getFileSize(file) {
          // Estimate file size based on patch length
          // This is a rough approximation
          return file.patch ? file.patch.length : 0;
        }
        
        function loadLargeFile() {
          isLargeFile.value = false;
          nextTick(() => {
            renderDiff(selectedFile.value);
          });
        }
        
        function getChangeSummary(file) {
          if (file.additions === 0 && file.deletions === 0) {
            return 'No changes';
          }
          
          const parts = [];
          if (file.additions > 0) {
            parts.push(`+${file.additions}`);
          }
          if (file.deletions > 0) {
            parts.push(`-${file.deletions}`);
          }
          
          return parts.join(', ');
        }
        
        function renderDiff(file) {
          if (!diffContainer.value) return;
          
          const patch = file.patch || '';
          const filename = file.filename;
          
          // Create a unified diff format that diff2html can parse
          const unifiedDiff = `diff --git a/${filename} b/${filename}
--- a/${filename}
+++ b/${filename}
${patch}`;
          
          // Configure diff2html options
          const options = {
            drawFileList: false,
            matching: 'lines', // or 'words'
            outputFormat: viewMode.value === 'split' ? 'side-by-side' : 'line-by-line',
            renderNothingWhenEmpty: true,
            highlightLanguage: getLanguageFromFilename(filename),
            theme: theme.value === 'theme-dark' ? 'dark' : 'light'
          };
          
          // Render the diff
          const diffHtml = Diff2Html.html(unifiedDiff, options);
          diffContainer.value.innerHTML = diffHtml;
          
          // Apply syntax highlighting
          Prism.highlightAllUnder(diffContainer.value);
          
          // Apply previous search if exists
          if (contentSearchQuery.value) {
            searchInContent();
          }
        }
        
        function getLanguageFromFilename(filename) {
          const ext = filename.split('.').pop().toLowerCase();
          const languageMap = {
            'js': 'javascript',
            'jsx': 'jsx',
            'ts': 'typescript',
            'tsx': 'tsx',
            'py': 'python',
            'rb': 'ruby',
            'java': 'java',
            'c': 'c',
            'cpp': 'cpp',
            'cs': 'csharp',
            'go': 'go',
            'php': 'php',
            'html': 'html',
            'css': 'css',
            'scss': 'scss',
            'md': 'markdown',
            'json': 'json',
            'xml': 'xml',
            'yaml': 'yaml',
            'yml': 'yaml',
            'sh': 'bash',
            'vue': 'vue'
          };
          
          return languageMap[ext] || 'plaintext';
        }
        
        function searchInContent() {
          if (!contentSearchQuery.value || !diffContainer.value) {
            contentSearchMatches.value = [];
            currentMatchIndex.value = 0;
            return;
          }
          
          // Remove previous highlights
          const previousHighlights = diffContainer.value.querySelectorAll('.search-highlight');
          previousHighlights.forEach(el => {
            const text = el.textContent;
            el.outerHTML = text;
          });
          
          try {
            // Create regex for search
            const flags = caseSensitiveSearch.value ? 'g' : 'gi';
            const regex = new RegExp(contentSearchQuery.value, flags);
            
            // Get all text nodes in the diff container
            const textNodes = [];
            const walker = document.createTreeWalker(
              diffContainer.value,
              NodeFilter.SHOW_TEXT,
              null,
              false
            );
            
            let node;
            while (node = walker.nextNode()) {
              // Skip empty or whitespace-only text nodes
              if (node.nodeValue.trim() === '') continue;
              
              // Skip nodes in non-content areas
              const parent = node.parentNode;
              if (parent.classList.contains('d2h-code-linenumber')) continue;
              
              textNodes.push(node);
            }
            
            // Find matches in text nodes and highlight them
            const matches = [];
            
            textNodes.forEach(textNode => {
              const text = textNode.nodeValue;
              let match;
              let lastIndex = 0;
              const matches_in_node = [];
              
              // Reset regex
              regex.lastIndex = 0;
              
              while ((match = regex.exec(text)) !== null) {
                matches_in_node.push({
                  node: textNode,
                  index: match.index,
                  text: match[0]
                });
              }
              
              if (matches_in_node.length > 0) {
                // Process matches in reverse order to avoid shifting indices
                matches_in_node.reverse().forEach(match => {
                  const matchStart = match.index;
                  const matchLength = match.text.length;
                  
                  // Split text node and insert highlight span
                  const beforeMatch = textNode.splitText(matchStart);
                  const matchNode = beforeMatch.splitText(matchLength);
                  
                  const highlightSpan = document.createElement('span');
                  highlightSpan.className = 'search-highlight';
                  highlightSpan.textContent = beforeMatch.nodeValue;
                  
                  beforeMatch.parentNode.replaceChild(highlightSpan, beforeMatch);
                  
                  // Add to match list
                  matches.push(highlightSpan);
                });
              }
            });
            
            contentSearchMatches.value = matches;
            currentMatchIndex.value = 0;
            
            // Scroll to first match if available
            if (matches.length > 0) {
              scrollToCurrentMatch();
            }
          } catch (err) {
            console.error('Error in content search:', err);
            error.value = `Search error: ${err.message}`;
            setTimeout(() => {
              error.value = null;
            }, 3000);
          }
        }
        
        function navigateToNextMatch() {
          if (contentSearchMatches.value.length === 0) return;
          
          currentMatchIndex.value = (currentMatchIndex.value + 1) % contentSearchMatches.value.length;
          scrollToCurrentMatch();
        }
        
        function navigateToPrevMatch() {
          if (contentSearchMatches.value.length === 0) return;
          
          currentMatchIndex.value = (currentMatchIndex.value - 1 + contentSearchMatches.value.length) % contentSearchMatches.value.length;
          scrollToCurrentMatch();
        }
        
        function scrollToCurrentMatch() {
          if (contentSearchMatches.value.length === 0) return;
          
          const match = contentSearchMatches.value[currentMatchIndex.value];
          
          // Remove current highlight class from all matches
          contentSearchMatches.value.forEach(m => {
            m.classList.remove('current-match');
          });
          
          // Add current highlight class to current match
          match.classList.add('current-match');
          
          // Scroll to match
          match.scrollIntoView({
            behavior: 'smooth',
            block: 'center'
          });
        }
        
        function toggleInlineComments() {
          showInlineComments.value = !showInlineComments.value;
          // In a real implementation, this would show/hide comment UI elements
        }
        
        // Watch for changes that require re-rendering
        watch(viewMode, () => {
          if (selectedFile.value) {
            nextTick(() => {
              renderDiff(selectedFile.value);
            });
          }
        });
        
        // Initialize app
        onMounted(() => {
          // Check for system dark mode preference
          if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            theme.value = 'theme-dark';
          }
          
          // Apply theme to body
          document.body.className = theme.value;
          
          // Check for saved GitHub token
          const token = localStorage.getItem('github_token');
          hasGithubToken.value = !!token;
          
          // Set example values for easy testing
          if (!githubRepoUrl.value) {
            githubRepoUrl.value = 'https://github.com/vuejs/vue';
            baseBranch.value = 'main';
            compareBranch.value = 'dev';
          }
        });
        
        return {
          // State
          theme,
          repoSource,
          loading,
          error,
          
          // Repository configuration
          githubRepoUrl,
          githubToken,
          hasGithubToken,
          localRepoPath,
          baseBranch,
          compareBranch,
          
          // File data
          fileChanges,
          selectedFile,
          viewMode,
          showInlineComments,
          
          // Filtering and search
          fileSearchQuery,
          contentSearchQuery,
          showFilterPanel,
          activeFilters,
          regexSearch,
          caseSensitiveSearch,
          contentSearchMatches,
          currentMatchIndex,
          
          // File content flags
          isBinaryFile,
          isLargeFile,
          
          // Computed
          availableExtensions,
          filteredFiles,
          isDiffAvailable,
          
          // DOM refs
          diffContainer,
          
          // Methods
          toggleTheme,
          fetchRepositoryData,
          loadLocalRepository,
          saveGithubToken,
          selectFile,
          getChangeSummary,
          toggleFilterPanel,
          addFilter,
          removeFilter,
          isFilterActive,
          applyRegexSearch,
          loadLargeFile,
          searchInContent,
          navigateToNextMatch,
          navigateToPrevMatch,
          toggleInlineComments
        };
      }
    });
    
    app.mount('#app');
  </script>
</body>
</html>